---
title: "Segmented regression model"
author: "Troy Hill (based on an R script provided with public comment from the Everglades Foundation)"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Segmented regression model}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE, echo=FALSE}
if(!"knitr" %in% installed.packages()){
  install.packages("knitr", repos='http://cran.us.r-project.org')
}
if(!"devtools" %in% installed.packages()){
  install.packages("devtools", repos='http://cran.us.r-project.org')
}
if(!"TTFF" %in% installed.packages()){
  devtools::install_github("troyhill/TTFF")
}

library(TTFF)

```

This document describes a possible alternative to the COP rainfall formula used to predict flows. A problem with the current approach is the substantial number of correlations among the 54 independent variables included. Principal component analysis is offered as a way to remove multicollinearity and reduce the dimensionality of the dataset while retaining all of the original variables and the information they provide. 

Principal component analysis (PCA) is one approach to reducing many variables to a few synthetic variables that are linear combinations of the original inputs (scaled to mean = 0). Importantly for our case, redundancy in the input parameters is of no consequence for the synthetic variables produced.


## Merging data for the period of record

To prepare the 41-year COP dataset for PCA, daily input data provided by the South Florida Water Management District were aggregated to weekly data. Mean values were used for stage, while sums were used for PET, rainfall, and lagged flows.



```{r compile data, include=TRUE, echo=TRUE, eval=FALSE}
### Load weekly data provided by Everglades Foundation with their public comment
csv_address <- system.file("extdata", "data_TTFF.csv", package="TTFF")

```

## Segmented regression
 

```{r PCA on whole dataset, echo = TRUE, fig.width = 4.5, fig.height = 4}
# Analysis ----------------------------------------------------------------

water <- read.csv(csv_address, header=T) 
water$Date <- as.POSIXct(water$Date, format = "%m/%d/%Y")
head(water)

waternew=water[,3:8]
head(waternew)
waternew=as.data.frame(waternew)
waternew=cbind(water$Qo, waternew)
names=names(water)
colnames(waternew)=c("Y",names[3:8])


### approximation of Tamiami Trail Flow Formula
ttff.mod <- lm(Y~WCA3A_Stg+ NESRS2_Stg + Qi + Rain + PET + Za, data = waternew) 
summary(ttff.mod) # R2 = 0.82
VIF(ttff.mod)
###


lin.mod <- lm(Y~WCA3A_Stg+ NESRS2_Stg, data=waternew)
summary(lin.mod)

#Test multicollinearity in the linear regression
VIF(lin.mod)

#breakpoints 
# for NESRS2
br1=7.00
br2=7.90

segmented.mod <- segmented(lin.mod, seg.Z = ~NESRS2_Stg, psi = list(NESRS2_Stg=c(br1,br2)))

summary(segmented.mod)
#AIC(segmented.mod)

#get the slopes for the different segments
slope(segmented.mod)

#get predicted Y values from models
fitted.data=fitted(segmented.mod)
water$pred.seg  <- fitted(segmented.mod)
water$pred.lm1  <- fitted(lin.mod)
water$pred.ttff <- fitted(ttff.mod)

### reshape dataframe and plot
long <- reshape2::melt(water[, c(1, 2, 9, 10, 11, 12)], id.vars = c("Date", "Year"))
levels(long$variable) <- c("observed flow", "segmented model (EF)", "linear model (EF)", "TTFF")

ggplot(long[!long$variable %in% "observed flow", ], aes(y = value, x = Date, col = variable)) + geom_line() + theme_classic() + ylab("Flow (cfs)")
# ggsave("timeSeries_ttff.png", height = 5, width = 12, dpi = 150)


### comparison of EF's segmented and linear models
plot(pred.seg ~ Qo, data = water, pch = 19, cex = 0.6, las = 1, xlab = "observed flow", ylab = "predicted")
points(y = water$pred.lm, x = water$Qo, pch = 19, cex = 0.6, col = "red4")
abline(lm(pred.seg ~ Qo, data = water), lwd = 3)
abline(lm(pred.lm1 ~ Qo, data = water), col = "red", lwd = 3)

plot(pred.seg ~ pred.lm1, data = water, pch = 19, cex = 0.6, las = 1, 
     xlab = "predicted (EF linear model)", ylab = "predicted (EF segmented model)",
     ylim = c(-500, 4000), xlim = c(-500, 4000))
abline(lm(pred.seg ~ pred.lm1, data = water), lty = 2)
summary(lm(pred.seg ~ pred.lm1, data = water))



### comparison of segmented model with TTFF
plot(pred.seg ~ Qo, data = water, pch = 19, cex = 0.4, las = 1, xlab = "observed flow", ylab = "predicted")
points(y = water$pred.ttff, x = water$Qo, pch = 19, cex = 0.4, col = "red4")
abline(lm(pred.seg ~ Qo, data = water), lwd = 3)
abline(lm(pred.ttff ~ Qo, data = water), col = "red", lwd = 3)

plot(pred.seg ~ pred.ttff, data = water, pch = 19, cex = 0.6, las = 1, 
     xlab = "predicted (TTFF)", ylab = "predicted (EF segmented model)",
     ylim = c(-500, 4000), xlim = c(-500, 4000))
abline(lm(pred.seg ~ pred.ttff, data = water), lty = 2)
summary(lm(pred.seg ~ pred.ttff, data = water))



###

```


```{r Plot PCA, echo = FALSE, fig.width = 4.5, fig.height = 4, fig.cap = "Figure 1. Comparison of annual water volumes delivered using segmented regression, multiple linear regression, and the iModel target."}

# Annual water volume figure  -----------------------------------------------
dd.wtr <- ddply(water, .(Year), summarise, 
                iModel    = sum(Qo * 360 * 24 * 7, na.rm = TRUE),
                TTFF      = sum(pred.ttff  * 360 * 24 * 7, na.rm = TRUE),
                segmented = sum(pred.seg  * 360 * 24 * 7, na.rm = TRUE)
                )
dd.wtr <- melt(dd.wtr[, -1])
ggplot(dd.wtr, aes(value / 43559.935 / 1000, colour = variable)) + stat_ecdf(geom = "point", pad = FALSE) + stat_ecdf(geom = "smooth", pad = FALSE) +
  theme_classic() + coord_flip() + scale_y_reverse() + ylab('Percentile (1 - exceedance probability)') + xlab('Annual volume (1k acre feet)')
# ggsave("C:/RDATA/rainfall_formula/EvergladesFoundation/ecdf.png", height = 5, width = 6, dpi = 150)

```

